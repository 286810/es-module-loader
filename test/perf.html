<!doctype html>
  <script>
    // delete window.Promise;
  </script>
  <script src="../dist/es6-module-loader.js"></script>
  <script>
    /* PARAMETERS */
    var TREE_DEPTH = 2;
    var NUM_MODULES = 1000;


    System.set('module0', System.newModule({}));
    System.instantiate = function(load) {
      var num = load.name.substr(6);

      var deps = [];
      if (num % TREE_DEPTH > 0)
        deps = ['module' + (num - 1)];

      return {
        deps: deps,
        execute: function() {
          eval(load.source);
          return System.newModule({});
        }
      };
    }

    function start() {
      document.body.innerHTML = '';
      var startTime = +Date.now();

      for (var i = 1; i <= NUM_MODULES; i++)
        System.define('module' + i, "function q() {} var p = 5;\n // non-trivial code");
      var promises = [];
      for (var i = NUM_MODULES; i > 1; i--) {
        promises.push(System.import('module' + i));
      }
      Promise.all(promises).then(function() {
        document.body.innerHTML = ((Date.now() - startTime) / NUM_MODULES) + 'ms per module';
      }).catch(function(e) {
        setTimeout(function() {
          throw e;
        })
      });
    }
  </script>
  <body onclick="start()" style="height:100%">
    <p>Click to start</p>